<?php
// セッション
session_start();

// データベースマネージャの読込
require_once "./php/DBManager.php";
$db = new DBManager();

$db->OutPutlog();

$result = $db->getProject($_GET['id']);
$user = $db->getUser($result['user_id']);

$rep = $db->getPrjReps($_GET['id']);

if (isset($_SESSION['login_id']) && $_SESSION['login_auth'] != 0) {
    $reped = $db->getUserPrjRep($_GET['id'],$_SESSION['login_id']);
    $userid = $_SESSION['login_id'];
} else {
    $reped = [
                "good" => "disabled",
                "download" => "disabled",
                "nice" => "disabled",
                "great" => "disabled",
                "effort" => "disabled"
            ];
}
?>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>プチコン３号作品倉庫</title>
</head>

<body>
    <?php require './php/nav.php'; ?>
    <div class="container-fluid">
        <div class="row p-1">
            <div class="col-8">
                <div class="section">
                    <h1><?php echo $result['project_name'] ?></h1>
                    <p>
                        投稿者：<?php echo $user['user_name']."・".$result['project_datetime'] ?>
                    </p>
                    <div class="m-1" id="tagfield">
                        <?php
                            $data = $db->getTagsByProject($_GET['id']);
                            foreach ($data as $key) {
                                echo '<a class="taglink" href="./search.html?searchtype=3&search='.$key['tag_name'].'">'.$key['tag_name'].'</a>';
                            }
                        ?>
                    </div>
                    <div id="imgfield">
                        <?php
                            if (file_exists("./img/projectimg/".(int)$_GET['id']."/img0.png")) {
                                echo '<img class="mb-1" width="100%" src="./img/projectimg/'.(int)$_GET['id'].'/img0.png" alt="pic">';
                            }
                        ?>
                        <div id="imglist">
                            <?php
                                for ($i = 0; $i < 4; $i++) {
                                    if (file_exists("./img/projectimg/".(int)$_GET['id']."/img".$i.".png")) {
                                        echo '<img width="20%" src="./img/projectimg/'.(int)$_GET['id'].'/img'.$i.'.png" alt="pic'.$i.'">';
                                    }
                                }
                            ?>
                        </div>
                    </div>
                    <h2>公開キー</h2>
                    <p class="text-uppercase">【<?php echo $result['project_pk'] ?>】</p>
                    <h2>概要</h2>
                    <p><?php echo $result['project_description'] ?></p>
                    <div id="repfield">
                        <button id="good" type="button" class="btn btn-outline-primary" onclick="sendhttpreq('good','<?php echo $_GET['id'] ?>','<?php echo $userid ?>')" <?php echo $reped['good'] ?>><i class="fa-regular fa-thumbs-up"></i>いいね！<span id="goodnum" class="ms-1"><?php echo $rep['good'] ?></span></button>
                        <button id="downloaded" type="button" class="btn btn-outline-success" onclick="sendhttpreq('downloaded','<?php echo $_GET['id'] ?>','<?php echo $userid ?>')" <?php echo $reped['download'] ?>><i class="fa-solid fa-file-arrow-down"></i>ダウンロードした！<span id="downloadednum" class="ms-1"><?php echo $rep['download'] ?></span></button>
                        <button id="nice" type="button" class="btn btn-outline-danger" onclick="sendhttpreq('nice','<?php echo $_GET['id'] ?>','<?php echo $userid ?>')" <?php echo $reped['nice'] ?>><i class="fa-regular fa-heart"></i>ステキ！<span id="nicenum" class="ms-1"><?php echo $rep['nice'] ?></span></button>
                        <button id="great" type="button" class="btn btn-outline-warning" onclick="sendhttpreq('great','<?php echo $_GET['id'] ?>','<?php echo $userid ?>')" <?php echo $reped['great'] ?>><i class="fa-regular fa-face-surprise"></i>すごい！<span id="greatnum" class="ms-1"><?php echo $rep['great'] ?></span></button>
                        <button id="effort" type="button" class="btn btn-outline-secondary" onclick="sendhttpreq('effort','<?php echo $_GET['id'] ?>','<?php echo $userid ?>')" <?php echo $reped['effort'] ?>><i class="fa-regular fa-face-smile-wink"></i>がんばって！<span id="effortnum" class="ms-1"><?php echo $rep['effort'] ?></span></button>
                    </div>
                </div>
            </div>
            <?php require './php/prjlist.php'; ?>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="./script/script.js"></script>
</body>

</html>